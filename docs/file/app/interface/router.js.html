<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">app/interface/router.js | express-supertest</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/error.js~AppError.html">AppError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-APP_NAME">APP_NAME</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-APP_VERSION">APP_VERSION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AWS_REGION">AWS_REGION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DYNAMODB_ENDPOINT">DYNAMODB_ENDPOINT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SECRET">SECRET</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVER_PORT">SERVER_PORT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TOTP_TTL">TOTP_TTL</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#domain">domain</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/domain/token-domain.js~Token.html">Token</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#infrastructure-datastore-dynamodb">infrastructure/datastore/dynamodb</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/infrastructure/datastore/dynamodb/app-repo-impl.js~AppRepositoryImpl.html">AppRepositoryImpl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/infrastructure/datastore/dynamodb/user-repo-impl.js~UserRepositoryImpl.html">UserRepositoryImpl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-docClient">docClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dynamodb">dynamodb</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#infrastructure-datastore-mongodb">infrastructure/datastore/mongodb</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/infrastructure/datastore/mongodb/user-repo-impl.js~UserRepositoryImpl.html">UserRepositoryImpl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-connection">connection</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#infrastructure-server">infrastructure/server</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-app">app</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#interface">interface</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/interface/interceptor.js~Interceptor.html">Interceptor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-router">router</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#usecase">usecase</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/usecase/echo-uc.js~EchoUsecase.html">EchoUsecase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/usecase/token-uc.js~AuthUsecase.html">AuthUsecase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/usecase/user-uc.js~UserUsecase.html">UserUsecase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/usecase/view-uc.js~ViewUsecase.html">ViewUsecase</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#usecase-repository">usecase/repository</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/usecase/repository/app-repo.js~AppRepository.html">AppRepository</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/app/usecase/repository/user-repo.js~UserRepository.html">UserRepository</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">app/interface/router.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

const express = require(&apos;express&apos;);
const router = express.Router();
const {body, validationResult} = require(&apos;express-validator&apos;);
const boom = require(&apos;boom&apos;);
const logger = require(&apos;../logger&apos;);
const Interceptor = require(&apos;./interceptor&apos;);
const userUC = require(&apos;../usecase/user-uc&apos;);
const tokenUC = require(&apos;../usecase/token-uc&apos;);
const pdfUC = require(&apos;../usecase/view-uc&apos;);
const echoUC = require(&apos;../usecase/echo-uc&apos;);

/////////////////////
// access logging
/////////////////////

router.use(Interceptor.accessLogging);

/////////////////////
// application logics
/////////////////////

router.get(&apos;/echo&apos;, (req, res) =&gt; {
  const result = echoUC.echo();
  res.status(200).json(result);
});

router.post(
  &apos;/auth&apos;,
  [
    body(&apos;id&apos;)
      .isString()
      .isLength({min: 1}),
    body(&apos;password&apos;)
      .isString()
      .isLength({min: 1}),
  ],
  async (req, res, next) =&gt; {
    // validator
    const errors = await validationResult(req);
    if (!errors.isEmpty()) {
      logger.warn(errors.array());
      next(boom.badRequest(errors.array()));
    } else {
      const id = req.body.id;
      const password = req.body.password;
      // &#x30B3;&#x30F3;&#x30C6;&#x30F3;&#x30C4;&#x30CD;&#x30B4;&#x30B7;&#x30A8;&#x30FC;&#x30B7;&#x30E7;&#x30F3;&#xFF08;&#x30A2;&#x30AF;&#x30BB;&#x30D7;&#x30C8;&#x30D8;&#x30C3;&#x30C0;&#x3092;&#x898B;&#x3066;&#x5206;&#x5C90;&#xFF09;
      res.format({
        &apos;application/json&apos;: () =&gt; {
          res.json({token: tokenUC.auth(id, password)});
        },
        default: () =&gt; {
          res.status(406).send(body406);
        },
      });
    }
  }
);

router.get(&apos;/user&apos;, tokenUC.verifyJWT, async (req, res) =&gt; {
  const id = req.query.id;
  const result = await userUC.getUser(id);
  res.format({
    &apos;application/json&apos;: () =&gt; {
      res.json(result);
    },
    default: () =&gt; {
      res.status(406).send(body406);
    },
  });
});

router.post(
  &apos;/user&apos;,
  tokenUC.verifyJWT,
  [
    body().custom(async value =&gt; {
      return await Interceptor.validateUserJson(value);
    }),
  ],
  async (req, res, next) =&gt; {
    // validator
    const errors = await validationResult(req);
    if (!errors.isEmpty()) {
      logger.warn(errors.array());
      next(boom.badRequest(errors.array()));
    } else {
      const id = req.body.id;
      const name = req.body.name;
      const result = await userUC.postUser(id, name);
      res.format({
        &apos;application/json&apos;: () =&gt; {
          res.json(result);
        },
        default: () =&gt; {
          res.status(406).send(body406);
        },
      });
    }
  }
);

router.get(&apos;/pdf&apos;, async (req, res) =&gt; {
  const result = await pdfUC.getPdf();
  res.send(result);
});

const body406 = {
  message: &apos;Not Acceptable&apos;,
};

module.exports = router;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
